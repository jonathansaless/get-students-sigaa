<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Extração e Adaptação de dados dos alunos no Sigaa para Moodle
        </title>
        <link rel="stylesheet" href="styles/style.css">
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
        <!-- <link rel="stylesheet" href="style.css"> -->
    </head>

    <body style="background-color: rgb(93, 99, 100);">
        <div class="container mt-5">
            <h1 class="text-center">Extração e Adaptação de dados dos alunos no
                Sigaa para Moodle</h1>
            <div id="fileForm" class="text-center">
                <label for="fileInput" class="form-label">
                    <b>Selecione o Arquivo HTML baixado no Sigaa</b>
                </label>
                <input type="file" id="fileInput" class="form-control"
                    accept=".html, .htm"><br><br>

                <!-- Campo para o período letivo, adicionado de index2.html -->
                <div class="mb-3">
                    <label for="periodoLetivo" class="form-label"><b>Insira o
                            período letivo (ex: 2024/2):</b></label>
                    <input type="text" id="periodoLetivo" class="form-control"
                        required>
                </div>

                <!-- Novo campo para o link do curso/sala -->
                <div class="mb-3">
                    <label for="linkCursoSala" class="form-label"><b>Insira o
                            link do Curso/Sala (ex:
                            https://ead.ufpa.br/course/view.php?id=7072):</b></label>
                    <input type="url" id="linkCursoSala" class="form-control"
                        required>
                </div>

                <label><b>Escolha a turma:</b></label><br>
                <div class="form-check form-check-inline">
                    <input type="radio" id="turma1" name="opcaoTurma" value="1"
                        checked class="form-check-input">
                    <label for="turma1" class="form-check-label">Cálculo 1 -
                        Manhã</label>
                </div>
                <div class="form-check form-check-inline">
                    <input type="radio" id="turma2" name="opcaoTurma" value="2"
                        class="form-check-input">
                    <label for="turma2" class="form-check-label">Cálculo 2 -
                        Manhã</label>
                </div>
                <div class="form-check form-check-inline">
                    <input type="radio" id="turma3" name="opcaoTurma" value="3"
                        class="form-check-input">
                    <label for="turma3" class="form-check-label">Cálculo 1 -
                        Tarde</label>
                </div>
                <div class="form-check form-check-inline">
                    <input type="radio" id="turma4" name="opcaoTurma" value="4"
                        class="form-check-input">
                    <label for="turma4" class="form-check-label">Cálculo 2 -
                        Tarde</label>
                </div><br><br>

                <label><b>Escolha o formato para download:</b></label><br>
                <div class="form-check form-check-inline">
                    <input type="radio" id="formatoCSV" name="formatoDownload"
                        value="csv" checked class="form-check-input">
                    <label for="formatoCSV" class="form-check-label">CSV</label>
                </div>
                <div class="form-check form-check-inline">
                    <input type="radio" id="formatoXLSX" name="formatoDownload"
                        value="xlsx" class="form-check-input">
                    <label for="formatoXLSX"
                        class="form-check-label">XLSX</label>
                </div><br><br>

                <button onclick="processFile()" class="btn btn-primary">Processar e baixar arquivo</button>
                <a id="downloadLink" class="btn btn-success mt-3"
                    style="display: none;"></a>
            </div>
        </div>

        <script>
        function processFile() {
            const fileInput = document.getElementById('fileInput');
            const downloadFormat = document.querySelector('input[name="formatoDownload"]:checked').value;
            const opcaoTurma = document.querySelector('input[name="opcaoTurma"]:checked').value;
            const periodoLetivo = document.getElementById('periodoLetivo').value;
            const linkCursoSala = document.getElementById('linkCursoSala').value; // Obter o link do curso/sala
            const file = fileInput.files[0];

            if (!file) {
                alert('Faça o upload de um arquivo primeiro.');
                return;
            }
            if (!periodoLetivo) {
                alert("Por favor, insira o período letivo.");
                return;
            }
            if (!linkCursoSala) { // Validar o link do curso/sala
                alert("Por favor, insira o link do Curso/Sala.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (event) {
                const html = event.target.result;
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const tables = doc.querySelectorAll('table.participantes');

                if (tables.length > 1) {
                    const table = tables[1];
                    const rows = table.querySelectorAll('tr');
                    const alunos = [];

                    rows.forEach(row => {
                        const aluno1 = extractAlunoData(row, 0);
                        const aluno2 = extractAlunoData(row, 1);

                        if (aluno1 && aluno1.nome) {
                            alunos.push(aluno1);
                        }
                        if (aluno2 && aluno2.nome) {
                            alunos.push(aluno2);
                        }
                    });

                    // Passar o linkCursoSala para a função processRows
                    processRows(alunos, opcaoTurma, periodoLetivo, linkCursoSala, downloadFormat);

                } else {
                    alert("Não foi possível encontrar a segunda tabela com a classe 'participantes'.");
                }
            };

            reader.readAsText(file, 'UTF-8');
        }

        function extractAlunoData(row, alunoIndex) {
            const aluno = {};
            const strongTags = row.querySelectorAll('strong');
            const emTags = row.querySelectorAll('em');

            const baseIndex = alunoIndex * 4;
            if (strongTags.length > alunoIndex && strongTags[alunoIndex].textContent.trim()) {
                aluno['nome'] = strongTags[alunoIndex].textContent.trim();
            }
            if (emTags.length > baseIndex && emTags[baseIndex].textContent.trim()) {
                aluno['curso'] = emTags[baseIndex].textContent.trim();
            }
            if (emTags.length > baseIndex + 1 && emTags[baseIndex + 1].textContent.trim()) {
                aluno['matricula'] = emTags[baseIndex + 1].textContent.trim();
            }
            // if (emTags.length > baseIndex + 2) aluno['usuario'] = emTags[baseIndex + 2].textContent.trim();
            if (emTags.length > baseIndex + 3 && emTags[baseIndex + 3].textContent.trim()) {
                aluno['email'] = emTags[baseIndex + 3].textContent.trim();
            }

            return aluno;
        }

        // Função processRows adaptada de index2.html para gerar o arquivo Moodle
        function processRows(rows, opcaoTurma, periodoLetivo, linkCursoSala, formatoDownload) {
            let turno, turmaNumber;
            switch (opcaoTurma) {
                case "1":
                    turmaNumber = "1";
                    turno = "MANHÃ";
                    break;
                case "2":
                    turmaNumber = "2";
                    turno = "MANHÃ";
                    break;
                case "3":
                    turmaNumber = "1";
                    turno = "TARDE";
                    break;
                case "4":
                    turmaNumber = "2";
                    turno = "TARDE";
                    break;
                default:
                    alert("Opção de turma inválida.");
                    return;
            }

            const output = [];
            // Adicionar 'Link do Curso/Sala' ao cabeçalho
            output.push(['Username', 'Password', 'Firstname', 'Lastname', 'Email', 'City', 'Course1', 'Group1', 'Type1', 'Group2', 'Type2', 'Papel no Curso', 'Link do Curso/Sala']);

            rows.forEach(row => {
                const matricula = row['matricula'] || '';
                const email = row['email'] || '';
                const fullName = row['nome'] || '';
                const names = fullName.split(' ');
                const firstname = names[0] ? names[0].toUpperCase() : '';
                const lastname = names.slice(1).map(name => name.toUpperCase()).join(' ');
                const curso = row['curso'] ? row['curso'].split('/')[0].trim() : '';
                const group1 = `${curso} - ${turno}`;
                const group2 = turno.charAt(0).toUpperCase() + turno.slice(1).toLowerCase();
                const turma = turmaNumber;

                // Adicionar o linkCursoSala à linha de dados
                output.push([matricula, 'newton123', firstname, lastname, email, 'Belém', `Página inicial Cálculo ${turma} - ${periodoLetivo}`, group1, '1', group2, '1', 'Estudante', linkCursoSala]);
            });

            const turmaMap = {
                "1": "calculo_1_manha_Moodle",
                "2": "calculo_2_manha_Moodle",
                "3": "calculo_1_tarde_Moodle",
                "4": "calculo_2_tarde_Moodle"
            };
            const turmaName = turmaMap[opcaoTurma];

            const downloadLink = document.getElementById('downloadLink');
            // downloadLink.style.display = 'block'; // Remover esta linha
            downloadLink.textContent = `Download Arquivo (${formatoDownload.toUpperCase()})`; // Manter o texto para acessibilidade, mas o link não será visível

            if (formatoDownload === 'csv') {
                const resultCSV = Papa.unparse(output, { quotes: true });
                // Adiciona o Byte Order Mark (BOM) para UTF-8
                const csvWithBOM = "\ufeff" + resultCSV;
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                downloadLink.href = url;
                downloadLink.download = `${turmaName}.csv`;
                downloadLink.click(); // Clicar programaticamente para iniciar o download
            } else if (formatoDownload === 'xlsx') {
                const worksheet = XLSX.utils.aoa_to_sheet(output);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
                const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([new Uint8Array(wbout)], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8' });
                const url = URL.createObjectURL(blob);
                downloadLink.href = url;
                downloadLink.download = `${turmaName}.xlsx`;
                downloadLink.click(); // Clicar programaticamente para iniciar o download
            } else {
                alert("Formato de download inválido.");
                downloadLink.style.display = 'none';
            }
        }
    </script>
    </body>

</html>